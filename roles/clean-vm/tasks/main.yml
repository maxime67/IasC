- name: Stop middleware services
  ignore_errors: true
  service:
    name: "{{ item }}"
    state: stopped
  loop: "{{ middleware_services }}"

- name: Remove middleware packages
  ignore_errors: true
  apt:
    name: "{{ item }}"
    state: absent
    loop: "{{ middleware_services }}"

- name: Remove configuration files
  ignore_errors: true
  file:
    path: "{{ item }}"
    state: absent
  loop: "{{ config_files }}"


- name: Clean up unused packages
  apt:
     autoremove: yes

- name: Clean up APT cache
  command: apt-get clean

- name: Reboot the VM
  reboot:
    msg: "Rebooting to finalize cleanup"
    timeout: 300
    test_command: whoami

- name: Wait for the VM to come back up
  wait_for:
    timeout: 300
    state: started